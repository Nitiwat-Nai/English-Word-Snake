<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Word Snake Game üêç (Premium Jungle)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- THEME & GLOBAL STYLES (Premium Jungle Theme) --- */
        :root {
            /* Palette: Deep Jungle & Gold */
            --color-primary: #2E7D32;
            /* Rich Green */
            --color-primary-dark: #1B5E20;
            --color-accent: #FFD700;
            /* Gold */
            --color-accent-shadow: #C6A700;

            --color-bg: #E8F5E9;
            /* Very light green bg */
            --color-card-bg: #FFFFFF;
            --color-text-dark: #1A3C34;
            /* Dark Jungle Green Text */
            --color-text-light: #FFFFFF;

            /* Snake Colors */
            --color-snake-head: #00695C;
            /* Teal Head */
            --color-snake-body: #4DB6AC;
            /* Teal Body */

            /* Game Board */
            --color-board-bg: #F1F8E9;
            --color-board-border: #33691E;

            /* Letter Colors */
            --color-letter-target: #D32F2F;
            /* Red */
            --color-letter-non-target: #FFECB3;
            /* Pale Yellow */
            --color-letter-text: #3E2723;

            /* Special Item */
            --color-golden-fruit: #FFD700;

            /* Difficulty Colors */
            --color-easy: #FFCA28;
            --color-medium: #66BB6A;
            --color-hard: #42A5F5;

            /* Grid Size */
            --grid-size: 15;
            --cell-size: 25px;

            /* Controls */
            --control-size: 65px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏≠‡πà‡∏≠‡∏ô */
            background: linear-gradient(135deg, #f0e68c 0%, #e0c598 100%);
            /* Light Brown/Khaki Gradient */
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.95);
            /* Glass-ish opaque */
            box-shadow: 0 20px 50px rgba(0, 50, 0, 0.3);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(10px);
        }

        header {
            background: linear-gradient(to right, var(--color-primary-dark), var(--color-primary));
            color: var(--color-text-light);
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            margin-bottom: 1rem;
            position: relative;
            z-index: 10;
        }

        header h1 {
            font-size: 1.6rem;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .screen {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Buttons --- */
        .btn-3d {
            border: none;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: 900;
            font-size: 1.1rem;
            padding: 1rem 2rem;
            border-radius: 50px;
            color: white;
            transition: transform 0.1s, box-shadow 0.1s;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 transparent !important;
        }

        /* Difficulty Buttons */
        .btn-easy {
            background: var(--color-easy);
            box-shadow: 0 5px 0 #FFB300;
            color: #3E2723;
        }

        .btn-medium {
            background: var(--color-medium);
            box-shadow: 0 5px 0 #388E3C;
        }

        .btn-hard {
            background: var(--color-hard);
            box-shadow: 0 5px 0 #1565C0;
        }

        .btn-primary {
            background: var(--color-primary);
            box-shadow: 0 5px 0 var(--color-primary-dark);
        }

        .btn-danger {
            background: #E53935;
            box-shadow: 0 5px 0 #C62828;
        }

        /* --- Game Board --- */
        .game-container {
            width: calc(var(--grid-size) * var(--cell-size));
            height: calc(var(--grid-size) * var(--cell-size));
            display: grid;
            grid-template-columns: repeat(var(--grid-size), 1fr);
            grid-template-rows: repeat(var(--grid-size), 1fr);
            border: 6px solid var(--color-board-border);
            border-radius: 10px;
            background-color: var(--color-board-bg);
            /* Subtle grid pattern */
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: var(--cell-size) var(--cell-size);
            margin: 10px auto;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .cell {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
        }

        /* Snake Styles */
        .snake-head {
            background: var(--color-snake-head);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 2;
            position: relative;
            transform-origin: center center;
            /* IMPORTANT for rotation */
            transition: transform 0.1s;
            /* For smooth rotation and eating effect */
        }

        /* --- Head Rotation & Eyes (Fix for Eye Direction) --- */

        /* Base Rotation for the entire head element */
        .snake-head[data-dir="UP"] {
            transform: rotate(-90deg);
        }

        .snake-head[data-dir="DOWN"] {
            transform: rotate(90deg);
        }

        .snake-head[data-dir="LEFT"] {
            transform: rotate(180deg);
        }

        .snake-head[data-dir="RIGHT"] {
            transform: rotate(0deg);
        }

        /* Eating Effect (Combined with rotation) */
        .snake-head.eaten[data-dir="UP"] {
            transform: rotate(-90deg) scale(1.3);
        }

        .snake-head.eaten[data-dir="DOWN"] {
            transform: rotate(90deg) scale(1.3);
        }

        .snake-head.eaten[data-dir="LEFT"] {
            transform: rotate(180deg) scale(1.3);
        }

        .snake-head.eaten[data-dir="RIGHT"] {
            transform: rotate(0deg) scale(1.3);
        }


        /* Eyes for the snake head (FIXED POSITIONING) */
        .snake-head::before,
        .snake-head::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            border: 1px solid black;
            right: 20%;
        }

        .snake-head::before {
            top: 25%;
        }

        .snake-head::after {
            bottom: 25%;
        }

        /* Flash Effect */
        .snake-body.flash-active,
        .snake-tail.flash-active {
            transform: scale(1.15);
            box-shadow: 0 0 15px white, 0 0 10px var(--color-accent);
            transition: transform 0.1s;
        }

        /* Letters */
        .letter-piece {
            font-weight: 900;
            font-size: 0.9rem;
            border-radius: 50%;
            color: var(--color-letter-text);
            background: var(--color-letter-non-target);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .letter-piece.target {
            background: var(--color-letter-target);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Golden Fruit */
        .golden-fruit {
            background: var(--color-golden-fruit);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--color-golden-fruit);
            animation: spin 2s linear infinite;
        }

        .golden-fruit::after {
            content: '‚≠ê';
            font-size: 12px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- HUD --- */
        .hud-panel {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            width: 90%;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-display {
            font-weight: 900;
            color: var(--color-primary-dark);
            font-size: 1.2rem;
        }

        .word-display {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--color-primary);
            letter-spacing: 2px;
        }

        /* Styling: Highlight collected letters */
        .word-display .collected-char {
            color: var(--color-snake-head);
        }

        .word-display .target-char {
            color: var(--color-letter-target);
        }

        /* --- Controls --- */
        .controls-area {
            display: grid;
            grid-template-areas:
                ". up ."
                "left down right";
            gap: 10px;
            margin-top: 10px;
        }

        .ctrl-btn {
            width: var(--control-size);
            height: var(--control-size);
            border-radius: 50%;
            border: none;
            background: var(--color-primary);
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 6px 0 var(--color-primary-dark), 0 10px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .ctrl-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 var(--color-primary-dark);
        }

        #ctrl-up {
            grid-area: up;
        }

        #ctrl-left {
            grid-area: left;
        }

        #ctrl-down {
            grid-area: down;
        }

        #ctrl-right {
            grid-area: right;
        }

        /* --- Overlay --- */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 80%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Sub-level Grid */
        .sub-level-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Word Snake üêç</h1>
        </header>

        <div id="start-screen" class="screen" style="display: flex;">
            <h2 style="color: var(--color-primary-dark);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
            <div style="width: 100%; max-width: 300px;">
                <button class="btn-3d btn-easy" onclick="unlockAudio(); showSubLevels('easy')">‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏á‡πà‡∏≤‡∏¢ (3-5
                    ‡∏≠‡∏±‡∏Å‡∏©‡∏£)</button>
                <button class="btn-3d btn-medium" onclick="unlockAudio(); showSubLevels('medium')">‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (6-8
                    ‡∏≠‡∏±‡∏Å‡∏©‡∏£)</button>
                <button class="btn-3d btn-hard" onclick="unlockAudio(); showSubLevels('hard')">‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏¢‡∏≤‡∏Å (9-12
                    ‡∏≠‡∏±‡∏Å‡∏©‡∏£)</button>
            </div>

            <div id="sub-level-area" class="hidden" style="width: 100%; margin-top: 20px;">
                <h3 id="sub-level-title" style="margin: 0 0 10px 0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô</h3>
                <div id="sub-level-buttons" class="sub-level-grid">
                    </div>
                <button class="btn-3d btn-danger" style="margin-top: 15px;" onclick="backToMain()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="hud-panel">
                <div>
                    <div style="font-size: 0.8rem; color: #666;">SCORE</div>
                    <div id="score-val" class="score-display">0</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.8rem; color: #666;">TARGET</div>
                    <div id="target-letter" class="score-display"
                        style="color: var(--color-letter-target); font-size: 1.5rem;">A</div>
                </div>
            </div>

            <div id="word-progress" class="word-display">_ _ _</div>
            <div style="font-size: 0.9rem; color: #555; margin-bottom: 5px;">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏™‡∏°</div>

            <div id="game-board" class="game-container"></div>

            <div class="controls-area">
                <button id="ctrl-up" class="ctrl-btn">‚¨ÜÔ∏è</button>
                <button id="ctrl-left" class="ctrl-btn">‚¨ÖÔ∏è</button>
                <button id="ctrl-down" class="ctrl-btn">‚¨áÔ∏è</button>
                <button id="ctrl-right" class="ctrl-btn">‚û°Ô∏è</button>
            </div>
        </div>

        <div id="summary-screen" class="screen">
            <h2 style="color: var(--color-primary);">üéâ ‡∏à‡∏ö‡πÄ‡∏•‡πÄ‡∏ß‡∏•!</h2>
            <div
                style="background: white; padding: 15px; border-radius: 10px; width: 100%; margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);">
                <ul id="summary-list" style="list-style: none; padding: 0; text-align: left;"></ul>
            </div>
            <button class="btn-3d btn-primary" id="btn-next-level">‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
            <button class="btn-3d btn-danger" onclick="backToMain()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <div id="overlay" class="hidden">
            <div class="modal">
                <h2 id="modal-title">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏´‡∏°?</h2>
                <p id="modal-msg">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå: CAT</p>
                <button id="modal-btn" class="btn-3d btn-primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
                <button id="modal-back-btn" class="btn-3d btn-danger hidden" onclick="backToMain()">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO SYSTEM (Web Audio API) ---
        class SoundManager {
            constructor() {
                this.ctx = null; // Lazy init
                this.enabled = true;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            playTone(freq, type, duration, vol = 0.1) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            playEat() { this.playTone(600, 'sine', 0.1, 0.2); setTimeout(() => this.playTone(800, 'sine', 0.1, 0.2), 50); }
            playMove() { /* Too repetitive, skipped */ }
            playWrong() { this.playTone(150, 'sawtooth', 0.3, 0.3); }
            playBonus() { this.playTone(1000, 'triangle', 0.1, 0.2); setTimeout(() => this.playTone(1500, 'triangle', 0.2, 0.2), 100); }
            playWin() {
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2, 0.1), i * 100));
            }
            playGameOver() {
                [400, 300, 200, 100].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.3, 0.2), i * 150));
            }
        }
        const audio = new SoundManager();
        const synth = window.speechSynthesis;

        // --- TTS (Text-to-Speech) Function (Revised) ---
        function speak(text, lang = 'en-US', callback = null) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Rate ‡πÉ‡∏´‡πâ‡∏ä‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            u.rate = (lang === 'en-US' ? 0.8 : 1.0); 

            if (callback && typeof callback === 'function') {
                u.onend = callback;
            } else {
                // If no callback, ensure it doesn't try to call non-function
                u.onend = null; 
            }

            synth.speak(u);
        }

        // Mobile Audio Unlock
        function unlockAudio() {
            audio.init();
            if (synth && !synth.speaking) {
                // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ TTS
                speak(''); 
            }
        }

        // --- GAME DATA ---
        const WORDS = {
            'easy': [
                [{ w: 'CAT', t: '‡πÅ‡∏°‡∏ß' }, { w: 'DOG', t: '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' }, { w: 'SUN', t: '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå' }, { w: 'MAP', t: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' }, { w: 'ZOO', t: '‡∏™‡∏ß‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå' }],
                [{ w: 'FISH', t: '‡∏õ‡∏•‡∏≤' }, { w: 'BIRD', t: '‡∏ô‡∏Å' }, { w: 'RAIN', t: '‡∏ù‡∏ô' }, { w: 'FIRE', t: '‡πÑ‡∏ü' }, { w: 'TREE', t: '‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ' }],
                [{ w: 'BALL', t: '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•' }, { w: 'BOOK', t: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠' }, { w: 'GAME', t: '‡πÄ‡∏Å‡∏°' }, { w: 'ROAD', t: '‡∏ñ‡∏ô‡∏ô' }, { w: 'MOON', t: '‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå' }],
                [{ w: 'FOUR', t: '‡∏™‡∏µ‡πà' }, { w: 'FIVE', t: '‡∏´‡πâ‡∏≤' }, { w: 'ZERO', t: '‡∏®‡∏π‡∏ô‡∏¢‡πå' }, { w: 'FAST', t: '‡πÄ‡∏£‡πá‡∏ß' }, { w: 'SLOW', t: '‡∏ä‡πâ‡∏≤' }],
                [{ w: 'GIRL', t: '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á' }, { w: 'BOY', t: '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢' }, { w: 'KING', t: '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≤' }, { w: 'QUEEN', t: '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ' }, { w: 'WALL', t: '‡∏Å‡∏≥‡πÅ‡∏û‡∏á' }],
                [{ w: 'RICE', t: '‡∏Ç‡πâ‡∏≤‡∏ß' }, { w: 'MEAT', t: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' }, { w: 'SOUP', t: '‡∏ã‡∏∏‡∏õ' }, { w: 'SALT', t: '‡πÄ‡∏Å‡∏•‡∏∑‡∏≠' }, { w: 'SUGAR', t: '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•' }],
                [{ w: 'HAND', t: '‡∏°‡∏∑‡∏≠' }, { w: 'FOOT', t: '‡πÄ‡∏ó‡πâ‡∏≤' }, { w: 'EYE', t: '‡∏ï‡∏≤' }, { w: 'NOSE', t: '‡∏à‡∏°‡∏π‡∏Å' }, { w: 'EAR', t: '‡∏´‡∏π' }],
                [{ w: 'COLD', t: '‡∏´‡∏ô‡∏≤‡∏ß' }, { w: 'HOT', t: '‡∏£‡πâ‡∏≠‡∏ô' }, { w: 'WET', t: '‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å' }, { w: 'DRY', t: '‡πÅ‡∏´‡πâ‡∏á' }, { w: 'WIND', t: '‡∏•‡∏°' }],
                [{ w: 'FROG', t: '‡∏Å‡∏ö' }, { w: 'SHIP', t: '‡πÄ‡∏£‡∏∑‡∏≠' }, { w: 'BLUE', t: '‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô' }, { w: 'PINK', t: '‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π' }, { w: 'STAR', t: '‡∏î‡∏≤‡∏ß' }],
                [{ w: 'SMILE', t: '‡∏¢‡∏¥‡πâ‡∏°' }, { w: 'LAUGH', t: '‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞' }, { w: 'SLEEP', t: '‡∏ô‡∏≠‡∏ô' }, { w: 'DREAM', t: '‡∏ù‡∏±‡∏ô' }, { w: 'WAKE', t: '‡∏ï‡∏∑‡πà‡∏ô' }]
            ],
            'medium': [
                [{ w: 'ORANGE', t: '‡∏™‡πâ‡∏°' }, { w: 'TICKET', t: '‡∏ï‡∏±‡πã‡∏ß' }, { w: 'PURPLE', t: '‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á' }, { w: 'FATHER', t: '‡∏û‡πà‡∏≠' }, { w: 'MOTHER', t: '‡πÅ‡∏°‡πà' }],
                [{ w: 'SCHOOL', t: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' }, { w: 'TRAVEL', t: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' }, { w: 'VACATION', t: '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' }, { w: 'FRIEND', t: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô' }, { w: 'FAMILY', t: '‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß' }],
                [{ w: 'MORNING', t: '‡πÄ‡∏ä‡πâ‡∏≤' }, { w: 'EVENING', t: '‡πÄ‡∏¢‡πá‡∏ô' }, { w: 'WEEKEND', t: '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' }, { w: 'HISTORY', t: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' }, { w: 'SCIENCE', t: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' }],
                [{ w: 'GARDEN', t: '‡∏™‡∏ß‡∏ô' }, { w: 'KITCHEN', t: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß' }, { w: 'WINDOW', t: '‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á' }, { w: 'DOORWAY', t: '‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π' }, { w: 'BUILDING', t: '‡∏ï‡∏∂‡∏Å' }],
                [{ w: 'PICTURE', t: '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' }, { w: 'CAMERA', t: '‡∏Å‡∏•‡πâ‡∏≠‡∏á' }, { w: 'JOURNAL', t: '‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£' }, { w: 'PROJECT', t: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' }, { w: 'SUCCESS', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' }],
                [{ w: 'HAPPEN', t: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô' }, { w: 'FINISH', t: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' }, { w: 'ACCEPT', t: '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö' }, { w: 'BELIEVE', t: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠' }, { w: 'DECIDE', t: '‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à' }],
                [{ w: 'WEATHER', t: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®' }, { w: 'CLOUDY', t: '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å' }, { w: 'SUNNY', t: '‡∏°‡∏µ‡πÅ‡∏î‡∏î' }, { w: 'STORMY', t: '‡∏°‡∏µ‡∏û‡∏≤‡∏¢‡∏∏' }, { w: 'FROZEN', t: '‡πÄ‡∏¢‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡πá‡∏á' }],
                [{ w: 'MONSTER', t: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏î' }, { w: 'SECRET', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö' }, { w: 'PUZZLE', t: '‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤' }, { w: 'GHOSTLY', t: '‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ú‡∏µ' }, { w: 'MYSTERY', t: '‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö' }],
                [{ w: 'BROTHER', t: '‡∏û‡∏µ‡πà/‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏¢' }, { w: 'SISTER', t: '‡∏û‡∏µ‡πà/‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏ß' }, { w: 'UNCLE', t: '‡∏•‡∏∏‡∏á/‡∏ô‡πâ‡∏≤/‡∏≠‡∏≤' }, { w: 'AUNT', t: '‡∏õ‡πâ‡∏≤/‡∏ô‡πâ‡∏≤/‡∏≠‡∏≤' }, { w: 'COUSIN', t: '‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á' }],
                [{ w: 'MOUNTAIN', t: '‡∏†‡∏π‡πÄ‡∏Ç‡∏≤' }, { w: 'FOREST', t: '‡∏õ‡πà‡∏≤' }, { w: 'PLANET', t: '‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå' }, { w: 'CASTLE', t: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó' }, { w: 'ADVENT', t: '‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ñ‡∏∂‡∏á' }]
            ],
            'hard': [
                [{ w: 'DICTATION', t: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ö‡∏≠‡∏Å' }, { w: 'AMAZEMENT', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏î‡πÉ‡∏à' }, { w: 'ADVENTURE', t: '‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢' }, { w: 'TECHNOLOGY', t: '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ' }, { w: 'RESTAURANT', t: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£' }],
                [{ w: 'COMPUTER', t: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { w: 'TELEVISION', t: '‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏®‡∏ô‡πå' }, { w: 'KNOWLEDGE', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ' }, { w: 'DIFFICULT', t: '‡∏¢‡∏≤‡∏Å' }, { w: 'EXCELLENT', t: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°' }],
                [{ w: 'COMMUNITY', t: '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô' }, { w: 'ECOLOGY', t: '‡∏ô‡∏¥‡πÄ‡∏ß‡∏®‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤' }, { w: 'EDUCATION', t: '‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤' }, { w: 'IMAGINE', t: '‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£' }, { w: 'LANGUAGE', t: '‡∏†‡∏≤‡∏©‡∏≤' }],
                [{ w: 'IMPORTANT', t: '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' }, { w: 'DIFFERENT', t: '‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á' }, { w: 'INTEREST', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à' }, { w: 'SUGGESTION', t: '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞' }, { w: 'GENERALLY', t: '‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' }],
                [{ w: 'CHOCOLATE', t: '‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï' }, { w: 'CALCULATE', t: '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' }, { w: 'DISCOVER', t: '‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö' }, { w: 'EXPLORER', t: '‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à' }, { w: 'INNOVATE', t: '‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πâ‡∏ô' }],
                [{ w: 'ATTENTION', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à' }, { w: 'CAPABILITY', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ' }, { w: 'DEFINITION', t: '‡∏Ñ‡∏≥‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°' }, { w: 'EXPERIENCE', t: '‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå' }, { w: 'GUARANTEE', t: '‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' }],
                [{ w: 'PROFESSION', t: '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û' }, { w: 'VOLUNTEER', t: '‡∏≠‡∏≤‡∏™‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£' }, { w: 'UNIVERSITY', t: '‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢' }, { w: 'APPRECIATE', t: '‡∏ã‡∏≤‡∏ö‡∏ã‡∏∂‡πâ‡∏á' }, { w: 'CEREMONY', t: '‡∏û‡∏¥‡∏ò‡∏µ' }],
                [{ w: 'CHAMPION', t: '‡πÅ‡∏ä‡∏°‡∏õ‡πå‡πÄ‡∏õ‡∏µ‡πâ‡∏¢‡∏ô' }, { w: 'DYNAMITE', t: '‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î' }, { w: 'FANTASTIC', t: '‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå' }, { w: 'INVISIBLE', t: '‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô' }, { w: 'MAGNITUDE', t: '‡∏Ç‡∏ô‡∏≤‡∏î' }],
                [{ w: 'TRANSPORT', t: '‡∏Ç‡∏ô‡∏™‡πà‡∏á' }, { w: 'COMPLEXITY', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô' }, { w: 'CHALLENGES', t: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢' }, { w: 'DISCOVERY', t: '‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö' }, { w: 'STRUCTURE', t: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á' }],
                [{ w: 'UNBELIEVABLE', t: '‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠' }, { w: 'INFORMATION', t: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' }, { w: 'CONGRATULATIONS', t: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢' }, { w: 'ENVIRONMENT', t: '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°' }, { w: 'OPPORTUNITY', t: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™' }]
            ]
        };

        // --- STATE ---
        const GRID = 15;
        let snake = [], dir = { x: 1, y: 0 }, nextDir = { x: 1, y: 0 };
        let currentWord = '', currentWordObj = null, letterIdx = 0;
        let levelData = [], levelIdx = 0, wordIdx = 0;
        let letters = [], goldenFruit = null;
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏°‡∏•‡∏á 50ms ‡∏à‡∏≤‡∏Å 200ms ‡πÄ‡∏õ‡πá‡∏ô 150ms
        const GAME_SPEED = 150; 
        let score = 0, gameInterval = null, isPlaying = false;
        let difficulty = 'easy';
        let isHeadEaten = false; 

        // --- DOM ---
        const els = {
            screens: document.querySelectorAll('.screen'),
            board: document.getElementById('game-board'),
            subLevelArea: document.getElementById('sub-level-area'),
            subLevelBtns: document.getElementById('sub-level-buttons'),
            score: document.getElementById('score-val'),
            target: document.getElementById('target-letter'),
            wordProgress: document.getElementById('word-progress'),
            overlay: document.getElementById('overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-msg'),
            modalBtn: document.getElementById('modal-btn'),
            modalBackBtn: document.getElementById('modal-back-btn'),
            summaryList: document.getElementById('summary-list'),
            btnNextLevel: document.getElementById('btn-next-level')
        };

        // --- LOGIC ---
        function showScreen(id) {
            els.screens.forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }

        function showSubLevels(diff) {
            difficulty = diff;
            els.subLevelArea.classList.remove('hidden');
            els.subLevelBtns.innerHTML = '';
            const colors = { easy: 'var(--color-easy)', medium: 'var(--color-medium)', hard: 'var(--color-hard)' };

            for (let i = 0; i < 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn-3d';
                btn.style.background = colors[diff];
                btn.style.color = '#3E2723';
                btn.textContent = `Level ${i + 1}`;
                btn.onclick = () => startLevel(i);
                els.subLevelBtns.appendChild(btn);
            }
        }

        function backToMain() {
            if (gameInterval) clearInterval(gameInterval);
            isPlaying = false;
            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
            if (synth.speaking) synth.cancel(); 
            showScreen('start-screen');
            els.subLevelArea.classList.add('hidden');
            els.overlay.classList.add('hidden');
        }

        function startLevel(idx) {
            levelIdx = idx;
            levelData = WORDS[difficulty][idx];
            wordIdx = 0;
            score = 0;
            els.score.textContent = score;
            prepareWord();
        }

        function prepareWord() {
            if (wordIdx >= levelData.length) {
                endLevel();
                return;
            }
            currentWordObj = levelData[wordIdx];
            currentWord = currentWordObj.w;
            letterIdx = 0;
            isHeadEaten = false;

            // Show Overlay
            showScreen('game-screen');
            els.overlay.classList.remove('hidden');
            els.modalTitle.textContent = `‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà ${wordIdx + 1}/${levelData.length}`;
            els.modalMsg.innerHTML = `‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤: <strong style="font-size:1.5rem; color:var(--color-primary);">${currentWord}</strong><br>(${currentWordObj.t})`;
            els.modalBtn.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°";
            els.modalBackBtn.classList.add('hidden');
            els.modalBtn.onclick = initGame;

            drawHUD();
            drawBoard(); // Clear board visually
            
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ modal 
            speak(currentWord, 'en-US');
        }

        function initGame() {
            els.overlay.classList.add('hidden');

            // Spawn Logic 
            snake = [{ x: 5, y: 7 }, { x: 4, y: 7 }, { x: 3, y: 7 }];
            dir = { x: 1, y: 0 }; // Start moving RIGHT
            nextDir = { x: 1, y: 0 };

            spawnLetters();
            goldenFruit = null;

            if (gameInterval) clearInterval(gameInterval);
            isPlaying = true;
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏´‡∏°‡πà 150ms
            gameInterval = setInterval(update, GAME_SPEED); 

            // Golden Fruit Timer
            setTimeout(spawnGoldenFruit, Math.random() * 5000 + 5000);
        }

        function spawnLetters() {
            letters = [];
            const occupied = new Set(snake.map(s => `${s.x},${s.y}`));
            // Reserve space in front of head to prevent instant eat/crash
            occupied.add(`${snake[0].x + 1},${snake[0].y}`);

            currentWord.split('').forEach(char => {
                let pos;
                do {
                    pos = { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
                } while (occupied.has(`${pos.x},${pos.y}`));
                occupied.add(`${pos.x},${pos.y}`);
                letters.push({ x: pos.x, y: pos.y, char: char });
            });
        }

        function spawnGoldenFruit() {
            if (!isPlaying) return;
            const occupied = new Set([...snake.map(s => `${s.x},${s.y}`), ...letters.map(l => `${l.x},${l.y}`)]);
            let pos;
            do {
                pos = { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
            } while (occupied.has(`${pos.x},${pos.y}`));

            goldenFruit = pos;
            // Despawn after 6 seconds
            setTimeout(() => { goldenFruit = null; }, 6000);
            // Schedule next spawn
            setTimeout(spawnGoldenFruit, Math.random() * 10000 + 10000);
        }

        // --- Word Complete Flash Logic ---
        function startWordCompleteFlash(callback) {
            const flashDuration = 100;
            const cycles = 4;
            let count = 0;

            const allSnakeCells = els.board.querySelectorAll('.snake-head, .snake-body, .snake-tail');

            // Remove the 'eaten' class which was applied just before stopping
            els.board.querySelector('.snake-head')?.classList.remove('eaten');

            // Inject temporary CSS for head flash (scale and rotation)
            const flashStyle = document.createElement('style');
            flashStyle.id = 'flash-temp-style';
            flashStyle.textContent = `
                .snake-head.flash-active[data-dir="UP"] { transform: rotate(-90deg) scale(1.15); box-shadow: 0 0 15px white, 0 0 10px var(--color-accent); }
                .snake-head.flash-active[data-dir="DOWN"] { transform: rotate(90deg) scale(1.15); box-shadow: 0 0 15px white, 0 0 10px var(--color-accent); }
                .snake-head.flash-active[data-dir="LEFT"] { transform: rotate(180deg) scale(1.15); box-shadow: 0 0 15px white, 0 0 10px var(--color-accent); }
                .snake-head.flash-active[data-dir="RIGHT"] { transform: rotate(0deg) scale(1.15); box-shadow: 0 0 15px white, 0 0 10px var(--color-accent); }
            `;
            document.head.appendChild(flashStyle);

            function toggleFlash() {
                if (count >= cycles) {
                    allSnakeCells.forEach(cell => cell.classList.remove('flash-active'));
                    flashStyle.remove();
                    callback();
                    return;
                }

                if (count % 2 === 0) {
                    // Flash ON (Zoom In)
                    allSnakeCells.forEach(cell => cell.classList.add('flash-active'));
                } else {
                    // Flash OFF (Zoom Out/Normal)
                    allSnakeCells.forEach(cell => cell.classList.remove('flash-active'));
                }

                count++;
                setTimeout(toggleFlash, flashDuration);
            }

            toggleFlash();
        }

        function wordComplete() {
            clearInterval(gameInterval);
            isPlaying = false;

            setTimeout(() => {
                startWordCompleteFlash(() => {
                    audio.playWin();
                    // ‡πÉ‡∏ä‡πâ speak ‡∏û‡∏£‡πâ‡∏≠‡∏° callback ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    speak(currentWord, 'en-US', () => {
                        wordIdx++;
                        prepareWord(); // proceed to next word/modal after speech
                    });
                });
            }, 50);

            return;
        }

        function update() {
            dir = nextDir;
            isHeadEaten = false;
            const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

            // Wall Collision
            if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) return gameOver();
            // Self Collision
            if (snake.some(s => s.x === head.x && s.y === head.y)) return gameOver();

            snake.unshift(head);

            // Check Letter Eat
            const targetChar = currentWord[letterIdx];
            const lIdx = letters.findIndex(l => l.x === head.x && l.y === head.y);

            let ate = false;
            if (lIdx !== -1) {
                if (letters[lIdx].char === targetChar) {
                    // Correct Letter
                    audio.playEat();
                    letters.splice(lIdx, 1);
                    letterIdx++;
                    score += 10;
                    ate = true;
                    isHeadEaten = true;

                    drawHUD(); 

                    if (letterIdx >= currentWord.length) {
                        drawBoard(isHeadEaten); // Draw final eating state
                        wordComplete();
                        return;
                    }
                } else {
                    // Wrong Letter
                    audio.playWrong();
                    gameOver(`‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏¥‡∏î! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö <strong>${targetChar}</strong>`);
                    return;
                }
            }

            // Check Golden Fruit
            if (goldenFruit && head.x === goldenFruit.x && head.y === goldenFruit.y) {
                audio.playBonus();
                score += 50;
                goldenFruit = null;
                // Grow extra segment
                ate = true;
                isHeadEaten = true;
            }

            if (!ate) snake.pop();

            drawHUD();
            drawBoard(isHeadEaten); 
        }

        function gameOver(msg = "‡∏ä‡∏ô‡πÅ‡∏•‡πâ‡∏ß!") {
            clearInterval(gameInterval);
            isPlaying = false;
            audio.playGameOver();

            els.overlay.classList.remove('hidden');
            els.modalTitle.textContent = "Game Over";
            els.modalMsg.innerHTML = msg;
            els.modalBtn.textContent = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
            els.modalBackBtn.classList.remove('hidden');
            els.modalBtn.onclick = initGame;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
        function readSummary(data) {
            if (synth.speaking) synth.cancel();
            
            let current = 0;
            
            function speakNext() {
                if (current >= data.length) return;
                
                const wordObj = data[current];
                
                // 1. English word
                speak(wordObj.w, 'en-US', () => {
                    // 2. Thai translation
                    speak(wordObj.t, 'th-TH', () => {
                        current++;
                        speakNext(); // Go to the next word
                    });
                });
            }
            
            speakNext();
        }

        function endLevel() {
            showScreen('summary-screen');
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ
            els.summaryList.innerHTML = levelData.map(d => `<li>‚úÖ <strong>${d.w}</strong> - ${d.t}</li>`).join('');

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
            readSummary(levelData);

            if (levelIdx < 9) {
                els.btnNextLevel.style.display = 'block';
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ ‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                els.btnNextLevel.onclick = () => { if(synth.speaking) synth.cancel(); startLevel(levelIdx + 1); };
            } else {
                els.btnNextLevel.style.display = 'none';
            }
        }

        // --- RENDER ---
        function drawHUD() {
            els.score.textContent = score;
            els.target.textContent = currentWord[letterIdx] || '‚úÖ';

            // Display collected letters clearly
            const wordDisplayHTML = currentWord.split('').map((c, i) => {
                if (i < letterIdx) {
                    return `<span class="collected-char">${c}</span>`;
                } else if (i === letterIdx) {
                    return `<span class="target-char">${c}</span>`;
                } else {
                    return `_`;
                }
            }).join(' ');

            els.wordProgress.innerHTML = wordDisplayHTML;
        }

        function drawBoard(isEating = false) {
            els.board.innerHTML = '';

            // Determine current direction string for CSS
            const currentDirString = dir.x === 1 ? 'RIGHT' : dir.x === -1 ? 'LEFT' : dir.y === -1 ? 'UP' : 'DOWN';

            // Draw Snake
            snake.forEach((s, i) => {
                const el = document.createElement('div');
                el.style.gridColumnStart = s.x + 1;
                el.style.gridRowStart = s.y + 1;

                if (i === 0) {
                    // Head: Apply eating class and direction for rotation
                    el.className = `cell snake-head${isEating ? ' eaten' : ''}`;
                    el.setAttribute('data-dir', currentDirString);
                } else if (i === snake.length - 1) {
                    // Tail
                    el.className = 'cell snake-tail';
                } else {
                    // Body
                    el.className = 'cell snake-body';
                }
                els.board.appendChild(el);
            });

            // Draw Letters
            letters.forEach(l => {
                const el = document.createElement('div');
                el.style.gridColumnStart = l.x + 1;
                el.style.gridRowStart = l.y + 1;
                el.className = `cell letter-piece ${l.char === currentWord[letterIdx] ? 'target' : ''}`;
                el.textContent = l.char;
                els.board.appendChild(el);
            });
            // Draw Golden Fruit
            if (goldenFruit) {
                const el = document.createElement('div');
                el.style.gridColumnStart = goldenFruit.x + 1;
                el.style.gridRowStart = goldenFruit.y + 1;
                el.className = 'cell golden-fruit';
                els.board.appendChild(el);
            }
        }

        // --- INPUT ---
        document.addEventListener('keydown', e => {
            if (!isPlaying) return;
            switch (e.key) {
                case 'ArrowUp': if (dir.y !== 1) nextDir = { x: 0, y: -1 }; break;
                case 'ArrowDown': if (dir.y !== -1) nextDir = { x: 0, y: 1 }; break;
                case 'ArrowLeft': if (dir.x !== 1) nextDir = { x: -1, y: 0 }; break;
                case 'ArrowRight': if (dir.x !== -1) nextDir = { x: 1, y: 0 }; break;
            }
        });

        ['up', 'down', 'left', 'right'].forEach(d => {
            document.getElementById(`ctrl-${d}`).addEventListener('click', () => {
                if (!isPlaying) return;
                if (d === 'up' && dir.y !== 1) nextDir = { x: 0, y: -1 };
                if (d === 'down' && dir.y !== -1) nextDir = { x: 0, y: 1 };
                if (d === 'left' && dir.x !== 1) nextDir = { x: -1, y: 0 };
                if (d === 'right' && dir.x !== -1) nextDir = { x: 1, y: 0 };
            });
        });

    </script>
</body>

</html>
